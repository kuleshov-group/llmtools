"""
Rounds to the grid [-1.5, -0.5, 0.5, 1.5]
"""

import torch
from torch import nn

from quip.lib.utils.matmul_had import matmul_hadU_cuda, matmul_hadUt_cuda

_KM8C_CODESZ = 8


def get_abs_grid():
    return torch.tensor([[0.3750, 0.3444, 0.3510, 0.3688, 0.3493, 0.3452, 0.3519, 0.3524],
                         [0.3748, 0.3883, 0.3716, 0.3624, 0.3769, 0.3724, 1.0030, 1.0782],
                         [0.3999, 0.3500, 0.3815, 0.3728, 0.3744, 1.0973, 0.3326, 1.0336],
                         [0.3729, 0.3777, 0.3766, 0.3864, 0.3774, 1.0619, 0.9985, 0.3626],
                         [0.3835, 0.3810, 0.3928, 0.3740, 1.1012, 0.3850, 0.3801, 1.1388],
                         [0.3895, 0.3810, 0.3821, 0.3655, 1.1428, 0.3809, 1.1258, 0.3866],
                         [0.4015, 0.3519, 0.3595, 0.3451, 1.0371, 1.0168, 0.3788, 0.3689],
                         [0.4012, 0.3867, 0.3784, 1.0764, 0.3734, 0.3617, 0.3738, 1.0524],
                         [0.3961, 0.3795, 0.3754, 1.1029, 0.3917, 0.3869, 1.1352, 0.3692],
                         [0.3931, 0.3984, 0.3827, 1.1218, 0.3707, 1.1205, 0.3900, 0.3760],
                         [0.3723, 0.3466, 0.3858, 1.0103, 1.0760, 0.3659, 0.3840, 0.3772],
                         [0.3670, 0.3842, 1.0301, 0.3294, 0.3903, 0.3678, 0.3666, 1.0554],
                         [0.3843, 0.3877, 1.1293, 0.3796, 0.3828, 0.3692, 1.0985, 0.3833],
                         [0.3841, 0.3884, 1.1327, 0.4009, 0.3857, 1.0820, 0.3708, 0.3814],
                         [0.3798, 0.3792, 1.1098, 0.4075, 1.1001, 0.3397, 0.4076, 0.3813],
                         [0.3600, 0.3976, 1.0913, 1.1103, 0.3888, 0.3927, 0.3875, 0.3562],
                         [0.3850, 1.1127, 0.3697, 0.3598, 0.3869, 0.3606, 0.3720, 1.1009],
                         [0.3786, 1.0985, 0.3797, 0.3695, 0.3873, 0.3759, 1.0388, 0.3806],
                         [0.3805, 1.0604, 0.3704, 0.4029, 0.3701, 0.9675, 0.3557, 0.3606],
                         [0.3899, 0.9423, 0.3557, 0.3635, 1.0806, 0.3473, 0.3693, 0.3628],
                         [0.3862, 1.1025, 0.3954, 1.0971, 0.3750, 0.3642, 0.3812, 0.3726],
                         [0.3682, 1.1095, 1.0286, 0.3898, 0.3778, 0.3607, 0.3675, 0.3732],
                         [1.1297, 0.3811, 0.3671, 0.3823, 0.3897, 0.3954, 0.3682, 1.0954],
                         [1.0767, 0.3837, 0.3805, 0.3737, 0.3865, 0.3746, 1.0666, 0.3783],
                         [1.1525, 0.3891, 0.3819, 0.3913, 0.3853, 1.1344, 0.3654, 0.3760],
                         [1.1737, 0.3565, 0.4013, 0.3641, 1.1628, 0.3896, 0.3974, 0.3988],
                         [1.1562, 0.3768, 0.3858, 1.1083, 0.3998, 0.3926, 0.3800, 0.3718],
                         [1.0592, 0.3694, 1.0675, 0.3736, 0.3848, 0.3668, 0.3634, 0.3752],
                         [1.1266, 1.1050, 0.3803, 0.3944, 0.3764, 0.3806, 0.3715, 0.3715],
                         [0.7245, 0.7522, 0.7150, 0.7527, 0.7333, 0.6942, 0.7262, 0.7614],
                         [0.3985, 0.3654, 0.4020, 0.4163, 0.3759, 0.3604, 0.3931, 1.8276],
                         [0.4042, 0.3725, 0.3985, 0.4046, 0.3952, 0.3525, 1.6845, 0.3510],
                         [0.3924, 0.3431, 0.4162, 0.4174, 0.3638, 1.7791, 0.3883, 0.3929],
                         [0.4257, 0.4117, 0.3642, 0.3942, 1.8568, 0.4106, 0.4312, 0.3787],
                         [0.4236, 0.3838, 0.3947, 1.7054, 0.3119, 0.3908, 0.3863, 0.4080],
                         [0.4146, 0.3518, 1.8023, 0.3784, 0.3906, 0.4002, 0.3924, 0.4091],
                         [0.4150, 1.8233, 0.4200, 0.4278, 0.3190, 0.4041, 0.4095, 0.4185],
                         [1.8095, 0.4158, 0.3836, 0.3908, 0.4168, 0.4116, 0.4234, 0.4139],
                         [0.3976, 0.4041, 0.3959, 0.4153, 1.3793, 1.1319, 1.2015, 1.1823],
                         [0.4250, 0.4370, 0.4321, 1.2895, 0.4218, 1.1892, 1.3137, 1.1859],
                         [0.4024, 0.4146, 0.3658, 1.2174, 1.2152, 0.3947, 1.2108, 1.2488],
                         [0.3995, 0.3817, 0.3792, 1.2495, 1.2298, 1.1996, 0.3947, 1.0805],
                         [0.3848, 0.3909, 0.3790, 1.1667, 1.2032, 1.1818, 1.1965, 0.3831],
                         [0.3721, 0.4147, 1.2966, 0.4186, 0.3553, 1.0902, 1.0994, 1.2297],
                         [0.4150, 0.4040, 1.1337, 0.4273, 1.1723, 0.4012, 1.2915, 1.3276],
                         [0.4180, 0.4225, 1.1069, 0.4171, 1.1790, 1.3587, 0.4167, 1.3820],
                         [0.3997, 0.4061, 1.2123, 0.4016, 1.0911, 1.2220, 1.2477, 0.4209],
                         [0.4050, 0.3874, 1.0625, 1.3218, 0.3994, 0.3905, 1.2309, 1.2697],
                         [0.4492, 0.4648, 1.2574, 1.3372, 0.4441, 1.4141, 0.4400, 1.2368],
                         [0.4166, 0.4007, 1.2812, 1.2419, 0.4059, 1.2647, 1.2242, 0.4136],
                         [0.4023, 0.4323, 1.1547, 1.2486, 1.2755, 0.4226, 0.4200, 1.2867],
                         [0.4664, 0.4404, 1.2871, 1.3598, 1.2443, 0.4441, 1.3441, 0.4896],
                         [0.3978, 0.3678, 1.2722, 1.2553, 1.1166, 1.2225, 0.3896, 0.3937],
                         [0.4029, 1.2506, 0.4181, 0.4243, 0.4231, 1.1309, 1.3503, 1.1972],
                         [0.4414, 1.2818, 0.4299, 0.4514, 1.2734, 0.4180, 1.2483, 1.3261],
                         [0.3875, 1.1856, 0.3698, 0.4031, 1.3037, 1.2045, 0.4025, 1.0674],
                         [0.4149, 1.2618, 0.4142, 0.3964, 1.2723, 1.2448, 1.2036, 0.3967],
                         [0.4173, 1.2567, 0.3725, 1.2151, 0.3931, 0.4078, 1.2419, 1.0932],
                         [0.4184, 1.2378, 0.3868, 1.2431, 0.4224, 1.2804, 0.4322, 1.1214],
                         [0.4389, 1.2587, 0.4434, 1.2912, 0.4541, 1.3155, 1.2787, 0.3905],
                         [0.3916, 1.2092, 0.3794, 1.1849, 1.1760, 0.3993, 0.3856, 1.0941],
                         [0.3985, 1.1819, 0.4089, 1.2433, 1.2804, 0.4060, 1.2145, 0.3977],
                         [0.4273, 1.2597, 0.3926, 1.2117, 1.2101, 1.2019, 0.3963, 0.3589],
                         [0.3970, 1.2723, 1.2140, 0.4234, 0.3974, 0.3954, 1.2557, 1.2857],
                         [0.4344, 1.3006, 1.2004, 0.4254, 0.3878, 1.2445, 0.3881, 1.1729],
                         [0.4233, 1.2389, 1.2190, 0.4055, 0.3841, 1.2565, 1.2736, 0.4067],
                         [0.4041, 1.2809, 1.1457, 0.3939, 1.1797, 0.4257, 0.4046, 1.2417],
                         [0.3854, 1.2491, 1.1796, 0.3749, 1.1475, 0.3951, 1.2711, 0.4219],
                         [0.3963, 1.2802, 1.2341, 0.4101, 1.0822, 1.2445, 0.4092, 0.3931],
                         [0.4126, 1.3361, 1.2731, 1.3702, 0.4223, 0.4710, 0.4600, 1.1465],
                         [0.3907, 1.1485, 1.1894, 1.2135, 0.4086, 0.4120, 1.2481, 0.3861],
                         [0.4057, 1.2327, 1.2225, 1.2819, 0.3884, 1.2893, 0.4143, 0.3728],
                         [0.3767, 1.1859, 1.2500, 1.1433, 1.2727, 0.3894, 0.3973, 0.3881],
                         [1.2487, 0.3827, 0.4053, 0.3860, 0.4029, 1.1001, 1.1978, 1.2458],
                         [1.2710, 0.4143, 0.4187, 0.3978, 1.3104, 0.4014, 1.2315, 1.1710],
                         [1.2362, 0.4338, 0.4057, 0.4156, 1.3121, 1.3000, 0.4210, 1.2548],
                         [1.2504, 0.4075, 0.4167, 0.4094, 1.2172, 1.2173, 1.2507, 0.4139],
                         [1.2253, 0.4176, 0.3743, 1.2306, 0.4141, 0.3784, 1.2034, 1.2460],
                         [1.3435, 0.4114, 0.4059, 1.3002, 0.4451, 1.2246, 0.4246, 1.1679],
                         [1.2161, 0.4077, 0.3826, 1.2104, 0.3870, 1.2119, 1.2477, 0.3922],
                         [1.2311, 0.4151, 0.3881, 1.1355, 1.2192, 0.4016, 0.4016, 1.3000],
                         [1.2470, 0.4176, 0.4055, 1.2257, 1.2290, 0.3984, 1.2452, 0.4026],
                         [1.2338, 0.4065, 0.3823, 1.1533, 1.2705, 1.1610, 0.4080, 0.3841],
                         [1.2218, 0.4113, 1.2265, 0.4002, 0.4056, 0.3845, 1.1980, 1.2495],
                         [1.1824, 0.3875, 1.1972, 0.4007, 0.3916, 1.1739, 0.3634, 1.1743],
                         [1.2209, 0.3878, 1.1617, 0.3794, 0.3711, 1.2269, 1.1594, 0.3980],
                         [1.2747, 0.4146, 1.1927, 0.3961, 1.2729, 0.4168, 0.4022, 1.2500],
                         [1.2446, 0.4159, 1.2719, 0.3943, 1.1300, 0.4124, 1.2513, 0.4008],
                         [1.3014, 0.4229, 1.2683, 0.4662, 1.2400, 1.3060, 0.4463, 0.4581],
                         [1.2882, 0.4241, 1.1628, 1.3389, 0.4221, 0.4271, 0.4358, 1.2893],
                         [1.2137, 0.3974, 1.1949, 1.1676, 0.3836, 0.3976, 1.1804, 0.4007],
                         [1.2032, 0.3893, 1.2398, 1.2556, 0.3860, 1.1989, 0.4021, 0.3885],
                         [1.2300, 0.3845, 1.2288, 1.2273, 1.2480, 0.4192, 0.4239, 0.4444],
                         [1.2516, 1.2413, 0.3939, 0.3987, 0.4048, 0.3645, 1.1972, 1.2112],
                         [1.3040, 1.2088, 0.4043, 0.4229, 0.4069, 1.2754, 0.4291, 1.1981],
                         [1.2036, 1.1942, 0.3765, 0.3990, 0.3960, 1.2018, 1.1726, 0.4084],
                         [1.2558, 1.2085, 0.3986, 0.3900, 1.1897, 0.4047, 0.4131, 1.2145],
                         [1.1953, 1.2108, 0.4021, 0.4040, 1.3093, 0.4114, 1.2122, 0.3999],
                         [1.2163, 1.1990, 0.4160, 0.3869, 1.1910, 1.1981, 0.3977, 0.3887],
                         [1.2876, 1.2283, 0.4068, 1.2549, 0.4153, 0.4036, 0.4040, 1.1476],
                         [1.2510, 1.2693, 0.3982, 1.1950, 0.4163, 0.4143, 1.2336, 0.3782],
                         [1.2884, 1.2624, 0.4537, 1.2716, 0.4225, 1.2731, 0.4188, 0.4136],
                         [1.2586, 1.1198, 0.3958, 1.1543, 1.1975, 0.3660, 0.3613, 0.3857],
                         [1.1818, 1.1908, 1.1856, 0.4107, 0.3886, 0.3701, 0.3835, 1.2084],
                         [1.2519, 1.2235, 1.2232, 0.4022, 0.3872, 0.4021, 1.2703, 0.4012],
                         [1.2493, 1.1702, 1.2217, 0.3911, 0.3813, 1.1402, 0.3992, 0.3877],
                         [1.1874, 1.1989, 1.2288, 0.4063, 1.2194, 0.3838, 0.3998, 0.4033],
                         [1.1981, 1.2411, 1.3027, 1.2799, 0.4347, 0.4170, 0.4168, 0.4004],
                         [0.5878, 0.5144, 0.5686, 0.5175, 0.4509, 1.4897, 0.5840, 2.4958],
                         [0.6623, 0.5879, 0.6560, 0.6962, 0.6853, 1.8720, 1.8070, 1.9068],
                         [0.4596, 0.4485, 0.4705, 0.4317, 0.4909, 1.7351, 1.0842, 1.1478],
                         [0.5221, 0.4872, 0.4726, 0.4984, 1.3920, 0.4729, 0.4955, 2.1567],
                         [0.4910, 0.4991, 0.4113, 0.5346, 1.4148, 0.4839, 2.0725, 0.5102],
                         [0.6174, 0.7690, 0.5728, 0.8249, 1.4942, 1.6200, 0.6436, 2.2089],
                         [0.4114, 0.4546, 0.4502, 0.4626, 0.4609, 1.2355, 1.8418, 0.4300],
                         [0.4653, 0.4675, 0.4417, 0.4808, 1.2751, 1.9539, 0.4681, 0.4071],
                         [0.6279, 0.6351, 0.6668, 0.6998, 1.8623, 1.8761, 1.8225, 0.6257],
                         [0.6700, 0.6410, 0.6612, 0.6793, 1.8687, 0.6117, 1.7845, 1.9404],
                         [0.6743, 0.6283, 0.6737, 0.6738, 2.4919, 1.2727, 0.6631, 1.5606],
                         [0.5247, 0.5112, 0.4819, 0.5215, 2.2613, 1.4874, 0.5378, 0.4442],
                         [0.6424, 0.6949, 0.6501, 1.9073, 0.6579, 0.6403, 1.8387, 1.8585],
                         [0.4571, 0.4289, 0.4637, 0.4601, 0.4443, 0.4468, 1.8767, 1.2081],
                         [0.4382, 0.3526, 0.4206, 1.0699, 0.4356, 1.0676, 0.4323, 1.6645],
                         [0.7542, 0.5564, 0.6127, 0.6485, 0.6301, 1.6831, 2.5765, 0.6588],
                         [0.5756, 0.5272, 0.5109, 0.5811, 0.4445, 2.2262, 0.4036, 1.5005],
                         [0.5336, 0.5095, 0.4189, 1.4166, 0.4965, 2.1337, 0.5074, 0.4877],
                         [0.5961, 0.4979, 0.5883, 1.5680, 0.5601, 0.5577, 0.6203, 2.5030],
                         [0.6071, 0.5240, 0.5426, 0.6054, 0.5713, 0.5339, 2.9974, 0.4744],
                         [0.6490, 0.5988, 0.6014, 1.7863, 1.8368, 1.8812, 0.6158, 0.6128],
                         [0.6657, 0.6234, 0.6040, 1.8848, 1.8129, 0.5884, 0.6053, 1.8281],
                         [0.6618, 0.6258, 0.6196, 1.8407, 1.8687, 0.6934, 1.9374, 0.6551],
                         [0.6157, 1.3290, 1.4175, 1.4562, 1.5159, 1.4368, 0.7616, 0.7628],
                         [0.6147, 0.6883, 0.6772, 3.1200, 0.5261, 0.6172, 0.7114, 0.7725],
                         [0.6581, 0.6606, 0.6552, 2.0461, 0.6767, 1.7766, 0.6410, 1.7810],
                         [0.6752, 0.6060, 0.6218, 1.9420, 0.6677, 1.8681, 1.8248, 0.6165],
                         [0.6860, 0.4606, 0.6275, 2.5880, 1.6679, 0.6384, 0.6741, 0.6048],
                         [0.4198, 0.4641, 0.4712, 2.0932, 0.5005, 0.4862, 1.3262, 0.4662],
                         [0.4457, 0.4518, 0.4794, 1.8314, 1.1313, 0.4259, 0.4514, 0.4376],
                         [0.7463, 0.6094, 0.8898, 0.5903, 0.7599, 0.5637, 0.7979, 3.1861],
                         [0.6373, 0.6404, 1.8356, 0.6406, 0.6004, 0.6168, 1.8131, 1.9615],
                         [0.5041, 0.5145, 1.3684, 0.4775, 0.4820, 0.5099, 0.4805, 2.0943],
                         [0.6319, 0.5874, 1.8477, 0.5648, 0.6157, 1.8793, 1.8215, 0.6865],
                         [0.4784, 0.4913, 1.3720, 0.4498, 0.4890, 2.0879, 0.4616, 0.5176],
                         [0.5136, 0.5210, 0.5078, 0.5444, 0.5181, 2.2031, 1.4362, 0.4044],
                         [0.6841, 0.7072, 1.8032, 0.6809, 1.8284, 0.6187, 0.6439, 2.0025],
                         [0.6294, 0.6577, 1.3766, 0.6155, 1.4478, 0.6494, 2.4828, 0.6515],
                         [0.6400, 0.5788, 1.8422, 0.5719, 1.8149, 1.9157, 0.6386, 0.6274],
                         [0.5724, 0.5760, 1.6058, 0.5438, 2.3884, 0.5154, 0.4442, 0.6121],
                         [0.4643, 0.4594, 1.0903, 0.5030, 1.8548, 0.4207, 1.1468, 0.4454],
                         [0.4562, 0.4492, 1.0190, 0.4265, 1.6534, 1.0233, 0.3668, 0.4309],
                         [0.6864, 0.6211, 1.8643, 1.8561, 0.7011, 0.6225, 0.6773, 1.8952],
                         [0.4758, 0.4689, 1.3663, 0.5119, 0.4390, 0.4927, 2.0801, 0.5089],
                         [0.6877, 0.6698, 1.5168, 1.5250, 0.6141, 2.4714, 0.7036, 0.6309],
                         [0.5000, 0.4284, 0.4997, 1.3926, 2.0563, 0.4979, 0.4896, 0.4993],
                         [0.4894, 0.4929, 0.4749, 2.0682, 0.5050, 0.4658, 0.4812, 1.4246],
                         [0.6270, 0.6508, 1.8281, 1.9294, 0.5865, 0.6550, 1.8354, 0.6883],
                         [0.4959, 0.4022, 0.5199, 2.1467, 0.5074, 1.3407, 0.4875, 0.4738],
                         [0.5184, 0.5153, 1.3990, 2.1679, 0.4899, 0.4889, 0.4728, 0.5027],
                         [0.6136, 0.5870, 2.4182, 0.5082, 0.4577, 0.5198, 0.5552, 1.5603],
                         [0.6567, 0.6100, 1.9429, 0.6180, 0.6212, 1.8334, 0.6225, 1.8088],
                         [0.4990, 0.5174, 2.1569, 0.4853, 0.4896, 1.3993, 0.5164, 0.4781],
                         [0.4551, 0.4488, 1.8087, 0.4101, 1.1306, 0.5270, 0.4598, 1.1542],
                         [0.6292, 0.5822, 2.1370, 0.6349, 1.7839, 0.7164, 1.5571, 0.7426],
                         [0.7909, 0.5349, 3.1552, 0.7064, 0.7094, 0.6913, 0.6767, 0.6196],
                         [0.4329, 0.4173, 1.5402, 0.9874, 0.3499, 0.4296, 0.3844, 1.1823],
                         [0.5192, 0.4835, 2.1215, 1.3816, 0.5002, 0.4236, 0.5413, 0.4544],
                         [0.6355, 0.6178, 2.3142, 1.8090, 0.6249, 1.4426, 0.6223, 0.6287],
                         [0.6327, 0.5853, 1.9104, 1.8046, 1.8125, 0.5724, 0.6048, 0.6154],
                         [0.4612, 1.5401, 0.5289, 0.4595, 0.5628, 0.5087, 0.5459, 2.4144],
                         [0.5935, 0.6970, 0.5951, 0.6092, 0.6663, 0.6499, 2.5814, 1.7052],
                         [0.4307, 0.8903, 0.4082, 0.3304, 0.5024, 1.0837, 0.4625, 1.6965],
                         [0.6879, 1.6968, 0.8037, 0.6989, 0.5250, 0.6251, 2.6131, 0.6330],
                         [0.6088, 1.8701, 0.6441, 0.6221, 0.6261, 1.8432, 0.6565, 1.7954],
                         [0.6676, 1.8374, 0.5921, 0.5687, 0.6612, 1.9216, 1.7825, 0.6899],
                         [0.6369, 1.7672, 0.5931, 0.6457, 1.8383, 0.6009, 0.5340, 1.8545],
                         [0.4590, 1.2493, 0.4155, 0.4548, 0.5188, 0.4642, 1.9246, 0.4331],
                         [0.6014, 0.6355, 0.6099, 0.6028, 1.5559, 2.4910, 0.6791, 1.2202],
                         [0.4737, 0.4766, 0.5100, 0.4854, 2.0445, 0.4013, 0.4669, 1.3240],
                         [0.5418, 0.5855, 0.4474, 0.5195, 2.4019, 0.5600, 1.5549, 0.5539],
                         [0.7035, 1.8056, 0.6084, 0.5747, 1.9318, 1.8208, 0.6272, 0.6177],
                         [0.4610, 1.0906, 0.4760, 1.0712, 0.4426, 0.3935, 0.4547, 1.7985],
                         [0.5336, 0.5136, 0.4901, 1.4753, 0.5121, 0.5141, 2.1842, 0.5203],
                         [0.4395, 1.1895, 0.4093, 0.4206, 0.4180, 1.7675, 0.4512, 0.4515],
                         [0.5493, 1.4925, 0.6235, 1.4638, 2.4012, 0.5811, 0.6870, 0.7035],
                         [0.6371, 1.9214, 0.6331, 1.8882, 0.6318, 0.6312, 0.6517, 1.7885],
                         [0.5973, 1.8424, 0.6059, 1.9435, 0.6480, 0.6043, 1.7852, 0.6105],
                         [0.7087, 1.4155, 0.6416, 2.4431, 0.5828, 1.6434, 0.5960, 0.6103],
                         [0.5073, 1.5205, 0.5965, 2.2348, 1.3735, 0.5284, 0.5481, 0.6402],
                         [0.6780, 1.8704, 1.7823, 0.6593, 0.6296, 0.6543, 0.5848, 1.8860],
                         [0.6209, 1.5832, 2.1604, 0.7710, 0.6653, 0.6978, 1.8796, 0.6596],
                         [0.6300, 1.5837, 0.6514, 0.6385, 0.6463, 2.5369, 0.5292, 0.5763],
                         [0.6683, 1.7990, 1.8327, 0.5747, 1.8697, 0.6293, 0.7484, 0.6367],
                         [0.5202, 1.3475, 0.4597, 2.0235, 0.4009, 0.4859, 0.4772, 0.4578],
                         [0.5466, 1.6254, 2.5682, 0.6321, 0.7035, 0.5941, 0.5521, 0.6289],
                         [0.4503, 0.4954, 2.1295, 0.4888, 0.4876, 0.4736, 1.3678, 0.5495],
                         [0.4338, 1.2056, 1.8326, 0.4449, 0.4205, 0.4521, 0.4615, 0.4868],
                         [0.5195, 0.5069, 2.1259, 0.4825, 1.3671, 0.5192, 0.4780, 0.3547],
                         [0.6807, 1.9105, 1.9012, 1.8904, 0.6760, 0.5754, 0.6416, 0.6358],
                         [0.6975, 2.0109, 0.5799, 0.6947, 0.6121, 0.6406, 1.7583, 1.8367],
                         [0.5189, 2.0883, 0.4679, 0.5171, 0.4921, 0.4997, 0.4725, 1.4037],
                         [0.6687, 3.1910, 0.7051, 0.6526, 0.5999, 0.6523, 0.6740, 0.7241],
                         [0.4310, 1.7717, 0.4409, 0.4463, 1.1320, 0.4317, 0.4493, 0.4162],
                         [0.6269, 1.8603, 0.6268, 0.6822, 1.8108, 0.6670, 1.9120, 0.6418],
                         [0.5229, 2.1275, 0.4930, 0.4407, 0.4869, 1.3721, 0.4882, 0.4806],
                         [0.5154, 2.2038, 0.4973, 1.4120, 0.5026, 0.4559, 0.4928, 0.4833],
                         [0.4935, 2.1306, 0.3845, 0.5031, 0.5064, 0.5210, 1.3840, 0.4887],
                         [0.6369, 2.2994, 0.6565, 1.4741, 0.6252, 1.6206, 0.6854, 0.6330],
                         [1.3407, 1.9877, 0.6443, 1.5051, 1.4527, 0.6441, 0.7231, 0.5996],
                         [1.3145, 1.1360, 1.2198, 1.0071, 0.9147, 1.1811, 1.2953, 1.2974],
                         [0.6477, 2.2702, 1.3651, 0.6191, 0.5641, 0.5804, 1.4003, 0.6025],
                         [0.6741, 1.9144, 1.8785, 0.5576, 0.6413, 1.8188, 0.6511, 0.6055],
                         [0.5832, 2.5392, 0.6138, 0.5939, 1.6471, 0.6221, 0.5945, 0.6456],
                         [0.5055, 2.1361, 1.3948, 0.5016, 0.5037, 0.4879, 0.4030, 0.4962],
                         [0.4754, 0.5103, 0.4736, 0.4869, 0.4852, 0.5030, 1.4023, 2.1237],
                         [1.8424, 0.6316, 0.6044, 0.5940, 0.5982, 0.6181, 1.8982, 1.8341],
                         [1.3602, 0.4023, 0.4471, 0.4955, 0.4906, 0.4914, 0.4817, 2.0693],
                         [1.4003, 0.4973, 0.5025, 0.4650, 0.5062, 0.5050, 2.0863, 0.5050],
                         [1.9168, 0.5844, 0.7135, 0.6529, 0.6533, 1.9134, 0.6580, 1.8028],
                         [1.8632, 0.6166, 0.6027, 0.6078, 0.6019, 1.9178, 1.6948, 0.6149],
                         [1.9495, 0.6720, 0.6600, 0.6686, 1.8020, 0.6771, 0.6479, 1.8864],
                         [2.1075, 0.4916, 0.4214, 0.4790, 0.5048, 0.4850, 1.3670, 0.5018],
                         [0.6702, 0.5320, 0.6996, 0.6113, 0.6179, 3.1383, 0.7150, 0.6053],
                         [2.2087, 0.5033, 0.5164, 0.4985, 1.4139, 0.5143, 0.5111, 0.5026],
                         [1.8366, 0.6616, 0.7113, 0.6222, 1.9337, 0.6312, 1.8500, 0.6947],
                         [1.9011, 0.6594, 0.6591, 0.6214, 1.8469, 1.9026, 0.6683, 0.6016],
                         [2.2188, 0.5377, 0.4986, 0.5320, 0.4927, 0.5157, 0.5096, 1.4291],
                         [1.9592, 0.6324, 0.6667, 1.4948, 0.6755, 0.7054, 2.0975, 0.6558],
                         [1.9300, 0.6212, 0.6624, 1.7835, 0.7340, 1.8787, 0.6381, 0.6106],
                         [0.7407, 0.6189, 0.6393, 0.7465, 3.1767, 0.5582, 0.6468, 0.6572],
                         [1.9582, 0.6815, 0.6075, 1.8946, 0.6398, 0.6553, 0.6828, 1.8503],
                         [1.4351, 0.6205, 0.6506, 2.2999, 0.6048, 0.5766, 1.3920, 0.5922],
                         [1.4122, 0.5126, 0.4797, 2.1362, 0.5227, 0.5089, 0.3929, 0.5156],
                         [1.9048, 0.6362, 0.6389, 1.7810, 1.8737, 0.6545, 0.6360, 0.6749],
                         [1.9162, 0.5946, 1.7692, 0.6128, 0.5768, 0.6227, 0.6001, 1.8147],
                         [1.5635, 0.5776, 1.9752, 0.6598, 0.5776, 0.6681, 1.9456, 0.6297],
                         [2.1904, 0.4944, 0.5173, 0.5190, 0.5141, 1.4105, 0.4751, 0.5067],
                         [1.4688, 0.5262, 0.5521, 0.5059, 2.2058, 0.5244, 0.5242, 0.5136],
                         [1.8726, 0.5898, 1.8473, 1.9356, 0.6722, 0.6336, 0.6373, 0.6587],
                         [1.4271, 0.5077, 2.1279, 0.5009, 0.4821, 0.4973, 0.5131, 0.5219],
                         [2.4672, 0.6668, 1.4722, 0.5994, 0.6076, 0.5936, 1.2933, 0.6219],
                         [1.8484, 0.6614, 1.8898, 0.6150, 0.5924, 1.8730, 0.5916, 0.6471],
                         [1.9323, 0.6848, 1.9700, 0.6505, 1.7531, 0.6683, 0.5788, 0.6764],
                         [1.9964, 0.4400, 1.2968, 0.5033, 0.4714, 0.4750, 0.4002, 0.4620],
                         [1.5717, 1.3308, 0.6126, 0.5928, 0.5875, 0.7214, 0.6998, 2.3199],
                         [1.9425, 1.8321, 0.6443, 0.5763, 0.6962, 0.7025, 1.8381, 0.6230],
                         [1.3968, 0.5172, 0.4821, 0.4597, 0.5255, 2.1413, 0.4741, 0.5089],
                         [0.5036, 1.3879, 0.5061, 0.4245, 2.0912, 0.4860, 0.4898, 0.4853],
                         [2.1772, 0.4649, 0.5126, 1.4164, 0.5176, 0.5054, 0.5438, 0.4719],
                         [1.8260, 1.8247, 1.8640, 0.6530, 0.6134, 0.6071, 0.6088, 0.6525],
                         [1.7907, 2.1775, 0.6559, 0.6841, 0.6099, 0.7065, 0.5885, 1.5430],
                         [1.3943, 2.1104, 0.4669, 0.4839, 0.4994, 0.4807, 0.5269, 0.4456],
                         [1.9352, 1.8703, 0.6988, 0.5678, 0.6428, 1.8053, 0.6231, 0.6341],
                         [1.9380, 1.8121, 0.6785, 0.5222, 1.8789, 0.6576, 0.6059, 0.6596],
                         [2.1245, 1.7103, 0.6678, 1.7833, 0.5368, 0.6065, 0.6857, 0.6200],
                         [2.1478, 1.3945, 0.5238, 0.4732, 0.5096, 0.4816, 0.4883, 0.4854],
                         [3.1894, 0.7335, 0.6627, 0.7281, 0.7155, 0.7308, 0.6488, 0.6838]])


def get_grid():
    signs = torch.cartesian_prod(*[torch.tensor([-1, 1])] * _KM8C_CODESZ)
    outer = signs.unsqueeze(0) * get_abs_grid().unsqueeze(1)
    return outer.reshape(-1, _KM8C_CODESZ)


_KM8C_GRID = get_grid()
_KM8C_GRID_NORM = torch.diag(_KM8C_GRID @ _KM8C_GRID.T)


class kmeans_8col(nn.Module):

    def __init__(self, build_truncated=True):
        super(kmeans_8col, self).__init__()
        self.register_buffer('grid', _KM8C_GRID)
        self.register_buffer('grid_norm', _KM8C_GRID_NORM)

        self.opt_scale = 1.0
        self.codesz = _KM8C_CODESZ
        self.idx_dtype = torch.int16
        self.idx_offset = -2**15

        if build_truncated:
            # 256 entries
            self.register_buffer('grid_part', get_abs_grid())
            self.register_buffer('grid_part_norm', torch.diag(self.grid_part @ self.grid_part.T))
            self.register_buffer('int_map', 2**torch.arange(_KM8C_CODESZ))

    def round(self, X, grid, grid_norm):
        assert X.shape[-1] == self.codesz
        Xqidx = (2 * X @ grid.T - grid_norm).argmax(-1)
        return grid[Xqidx], Xqidx

    def quantize(self, X, return_idx=True):
        flips = self.to_int(X < 0) << 8
        mask = 1 - 2 * (X < 0).to(torch.float32)

        X_part = torch.abs(X)
        roundout, Xqidx = self.round(X_part, self.grid_part, self.grid_part_norm)
        vals = roundout * mask
        if not return_idx:
            return vals
        return vals, (flips + Xqidx + self.idx_offset).to(self.idx_dtype)

    def to_int(self, mask):
        return (self.int_map.unsqueeze(0) * mask.int()).sum(dim=-1)

    def to_mask(self, int):
        return 1 - 2 * ((self.int_map & int.unsqueeze(-1)) > 0)

    def by_idxs(self, idxs):
        idxs = idxs.int() - self.idx_offset
        mask = self.to_mask(idxs >> 8)
        return self.grid_part[idxs & 255] * mask


class KMeans8ColLinear(nn.Module):

    def __init__(self, device):
        super().__init__()
        self.codebook = kmeans_8col().to(torch.float16).to(device)

    def forward(self,
                input,
                Qidxs,
                SU,
                SV,
                Wscale,
                rank=-1,
                A=None,
                B=None,
                rescale_WH=False,
                scaleWH=None):
        (m, n) = Qidxs.shape

        x = input.view(-1, n * _KM8C_CODESZ).to(torch.float32)
        if rescale_WH:
            x /= scaleWH
        x = x * SU
        x = matmul_hadUt_cuda(x)

        if rank > 0:
            Bx = x @ B.t().to(torch.float32)
            ABx = Bx @ A.t().to(torch.float32)

        num_scale = 1024
        x = x / num_scale
        x = x.to(torch.float16)

        W_decompressed = self.codebook.by_idxs(Qidxs).reshape(-1, n * _KM8C_CODESZ)
        z = x @ W_decompressed.t()

        x = z.to(torch.float32)
        x = x * (Wscale * num_scale)

        if rank > 0:
            x = x + ABx.to(torch.float32)

        x = matmul_hadU_cuda(x)
        x = x * SV

        output = x.view(*input.shape[:-1], m)

        return output
